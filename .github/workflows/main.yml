---
name: Sync Public and Private Repositories

on:
  # schedule:
  #   - cron: "0 0 * * *"
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync_repo:
    runs-on: self-hosted
    steps:
      - name: Install Git LFS
        run: |
          if ! git lfs; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install git-lfs
            git lfs install
          fi
          
      - name: Checkout Private Repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repository: Linux-Audio/sound
          path: private-repo
          fetch-depth: 0
          lfs: true

      - name: Remove existing public-repo directory (if exists)
        run: rm -rf public-repo

      - name: Clone Public Repository
        run: git clone https://git.kernel.org/pub/scm/linux/kernel/git/broonie/sound.git public-repo

      - name: Configure Git
        run: |
          git config user.name "Syed Saba Kareem"
          git config user.email "syed.sabakareem@amd.com"
      - name: Commit changes with LFS
        run: |
          rsync -av --exclude='.git' public-repo/ private-repo/
          cd private-repo
          git lfs track "*.h" "*.d"
          git add --all
          git commit -m "Sync with public repository"
      - name: Push changes
        run: |
          cd private-repo
          git push origin main
